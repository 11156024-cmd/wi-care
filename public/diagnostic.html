<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wi-Care ç³»çµ±è¨ºæ–·</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #f5f5f5;
            padding: 20px;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        h1 {
            color: #333;
            margin-bottom: 20px;
            border-bottom: 3px solid #667eea;
            padding-bottom: 10px;
        }
        
        .test-section {
            margin: 30px 0;
            padding: 20px;
            background: #f9f9f9;
            border-left: 4px solid #667eea;
            border-radius: 8px;
        }
        
        .test-section h2 {
            color: #667eea;
            font-size: 16px;
            margin-bottom: 15px;
        }
        
        .button-group {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        
        button {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: #667eea;
            color: white;
        }
        
        .btn-primary:hover {
            background: #5568d3;
        }
        
        .btn-success {
            background: #51cf66;
            color: white;
        }
        
        .btn-success:hover {
            background: #40c057;
        }
        
        .btn-danger {
            background: #ff6b6b;
            color: white;
        }
        
        .btn-danger:hover {
            background: #ff5252;
        }
        
        .output {
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            max-height: 200px;
            overflow-y: auto;
            margin: 10px 0;
            color: #333;
        }
        
        .output.error {
            border-left: 4px solid #ff6b6b;
            background: #ffe0e0;
        }
        
        .output.success {
            border-left: 4px solid #51cf66;
            background: #e0ffe0;
        }
        
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
            vertical-align: middle;
        }
        
        .status-indicator.ok {
            background: #51cf66;
        }
        
        .status-indicator.error {
            background: #ff6b6b;
        }
        
        .status-indicator.pending {
            background: #ffd43b;
        }
        
        .info-text {
            color: #666;
            font-size: 14px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ¥ Wi-Care ç³»çµ±è¨ºæ–·å·¥å…·</h1>
        
        <!-- æ¸¬è©¦ 1: ESP32 é€£æ¥ -->
        <div class="test-section">
            <h2><span class="status-indicator pending" id="esp32-status"></span>ESP32 é€£æ¥æ¸¬è©¦</h2>
            <div class="info-text">æ¸¬è©¦æ‡‰ç”¨ç¨‹å¼æ˜¯å¦èƒ½é€£æ¥åˆ° ESP32 ä¼ºæœå™¨ (172.20.10.9:8080)</div>
            <div class="button-group">
                <button class="btn-primary" onclick="testESP32Connection()">ğŸ” æ¸¬è©¦é€£æ¥</button>
            </div>
            <div class="output" id="esp32-output" style="display:none;"></div>
        </div>
        
        <!-- æ¸¬è©¦ 2: ç²å–è¨­å‚™ç‹€æ…‹ -->
        <div class="test-section">
            <h2><span class="status-indicator pending" id="status-test"></span>è¨­å‚™ç‹€æ…‹æ¸¬è©¦</h2>
            <div class="info-text">å¾ ESP32 ç²å–ç•¶å‰è¨­å‚™ç‹€æ…‹</div>
            <div class="button-group">
                <button class="btn-primary" onclick="fetchDeviceStatus()">ğŸ“Š ç²å–ç‹€æ…‹</button>
                <button class="btn-primary" onclick="continuousFetch()">ğŸ”„ é€£çºŒè¼ªè©¢ (10ç§’)</button>
            </div>
            <div class="output" id="status-output" style="display:none;"></div>
        </div>
        
        <!-- æ¸¬è©¦ 3: æ¨¡æ“¬è·Œå€’ -->
        <div class="test-section">
            <h2><span class="status-indicator pending" id="fall-test"></span>è·Œå€’è§¸ç™¼æ¸¬è©¦</h2>
            <div class="info-text">æ‰‹å‹•è§¸ç™¼è·Œå€’æª¢æ¸¬ï¼Œè§€å¯Ÿæ‡‰ç”¨ç¨‹å¼æ˜¯å¦å³æ™‚æ›´æ–°</div>
            <div class="button-group">
                <button class="btn-danger" onclick="triggerFall()">ğŸ”´ è§¸ç™¼è·Œå€’</button>
                <button class="btn-success" onclick="clearFall()">ğŸŸ¢ æ¸…é™¤è·Œå€’</button>
            </div>
            <div class="output" id="fall-output" style="display:none;"></div>
        </div>
        
        <!-- æ¸¬è©¦ 4: åŒæ­¥æª¢æŸ¥ -->
        <div class="test-section">
            <h2><span class="status-indicator pending" id="sync-test"></span>æ‡‰ç”¨ç¨‹å¼åŒæ­¥æª¢æŸ¥</h2>
            <div class="info-text">é©—è­‰æ‡‰ç”¨ç¨‹å¼æ˜¯å¦æ­£ç¢ºåŒæ­¥ ESP32 ç‹€æ…‹</div>
            <div class="button-group">
                <button class="btn-primary" onclick="syncTest()">âš¡ åŸ·è¡ŒåŒæ­¥æ¸¬è©¦</button>
            </div>
            <div class="output" id="sync-output" style="display:none;"></div>
        </div>
    </div>

    <script>
        const ESP32_URL = 'http://172.20.10.9:8080';
        let continuousInterval = null;

        function log(elementId, message, isError = false) {
            const elem = document.getElementById(elementId);
            elem.style.display = 'block';
            const timestamp = new Date().toLocaleTimeString('zh-TW');
            const line = `[${timestamp}] ${message}`;
            
            if (elem.textContent) {
                elem.textContent += '\n' + line;
            } else {
                elem.textContent = line;
            }
            
            elem.scrollTop = elem.scrollHeight;
            
            if (isError) {
                elem.classList.add('error');
                elem.classList.remove('success');
            }
        }

        function clearLog(elementId) {
            const elem = document.getElementById(elementId);
            elem.textContent = '';
            elem.style.display = 'none';
            elem.classList.remove('error', 'success');
        }

        async function testESP32Connection() {
            clearLog('esp32-output');
            updateStatus('esp32-status', 'pending');
            
            try {
                log('esp32-output', 'æ­£åœ¨æ¸¬è©¦é€£æ¥åˆ° ' + ESP32_URL + '...');
                
                const response = await fetch(ESP32_URL + '/health', {
                    method: 'GET',
                    mode: 'cors',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    log('esp32-output', 'âœ… é€£æ¥æˆåŠŸï¼');
                    log('esp32-output', 'ä¼ºæœå™¨ç‹€æ…‹: ' + JSON.stringify(data));
                    document.getElementById('esp32-output').classList.add('success');
                    updateStatus('esp32-status', 'ok');
                } else {
                    log('esp32-output', 'âŒ ä¼ºæœå™¨è¿”å›éŒ¯èª¤: ' + response.status, true);
                    updateStatus('esp32-status', 'error');
                }
            } catch (error) {
                log('esp32-output', 'âŒ é€£æ¥å¤±æ•—: ' + error.message, true);
                log('esp32-output', 'å¯èƒ½åŸå› : CORS é˜»æ­¢ã€é˜²ç«ç‰†ã€æˆ– ESP32 é›¢ç·š', true);
                updateStatus('esp32-status', 'error');
            }
        }

        async function fetchDeviceStatus() {
            clearLog('status-output');
            updateStatus('status-test', 'pending');
            
            try {
                log('status-output', 'æ­£åœ¨å¾ ESP32 ç²å–è¨­å‚™ç‹€æ…‹...');
                
                const response = await fetch(ESP32_URL + '/status', {
                    method: 'GET',
                    mode: 'cors'
                });
                
                const data = await response.json();
                log('status-output', 'âœ… ç‹€æ…‹ç²å–æˆåŠŸ');
                log('status-output', JSON.stringify(data, null, 2));
                document.getElementById('status-output').classList.add('success');
                updateStatus('status-test', 'ok');
            } catch (error) {
                log('status-output', 'âŒ ç²å–ç‹€æ…‹å¤±æ•—: ' + error.message, true);
                updateStatus('status-test', 'error');
            }
        }

        async function triggerFall() {
            clearLog('fall-output');
            updateStatus('fall-test', 'pending');
            
            try {
                log('fall-output', 'æ­£åœ¨è§¸ç™¼è·Œå€’æª¢æ¸¬...');
                
                const response = await fetch(ESP32_URL + '/trigger-fall', {
                    method: 'POST',
                    mode: 'cors',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                log('fall-output', 'âœ… è·Œå€’å·²è§¸ç™¼');
                log('fall-output', JSON.stringify(data, null, 2));
                log('fall-output', 'ğŸ“± æª¢æŸ¥æ‡‰ç”¨ç¨‹å¼ç•Œé¢ - æ‡‰è©²é¡¯ç¤º "âš ï¸ ç·Šæ€¥" ä¸¦æ’­æ”¾è­¦å ±');
                document.getElementById('fall-output').classList.add('success');
                updateStatus('fall-test', 'ok');
            } catch (error) {
                log('fall-output', 'âŒ è§¸ç™¼å¤±æ•—: ' + error.message, true);
                updateStatus('fall-test', 'error');
            }
        }

        async function clearFall() {
            clearLog('fall-output');
            
            try {
                log('fall-output', 'æ­£åœ¨æ¸…é™¤è·Œå€’ç‹€æ…‹...');
                
                const response = await fetch(ESP32_URL + '/clear-fall', {
                    method: 'POST',
                    mode: 'cors'
                });
                
                const data = await response.json();
                log('fall-output', 'âœ… è·Œå€’ç‹€æ…‹å·²æ¸…é™¤');
                log('fall-output', JSON.stringify(data, null, 2));
                log('fall-output', 'ğŸ“± æ‡‰ç”¨ç¨‹å¼æ‡‰è©²å›åˆ° "ä¸€åˆ‡å®‰å¥½" ç‹€æ…‹');
                document.getElementById('fall-output').classList.add('success');
            } catch (error) {
                log('fall-output', 'âŒ æ¸…é™¤å¤±æ•—: ' + error.message, true);
            }
        }

        async function continuousFetch() {
            clearLog('status-output');
            
            if (continuousInterval) {
                clearInterval(continuousInterval);
                log('status-output', 'âŒ å·²åœæ­¢é€£çºŒè¼ªè©¢');
                return;
            }
            
            let count = 0;
            log('status-output', 'é–‹å§‹é€£çºŒè¼ªè©¢ (æ¯ç§’)...');
            
            continuousInterval = setInterval(async () => {
                try {
                    const response = await fetch(ESP32_URL + '/status', { mode: 'cors' });
                    const data = await response.json();
                    count++;
                    log('status-output', `[${count}] ç‹€æ…‹: ${data.status} | åŠ é€Ÿåº¦: ${data.magnitude?.toFixed(2) || 'N/A'}G`);
                } catch (error) {
                    log('status-output', `[${count}] âŒ è¼ªè©¢å¤±æ•—: ${error.message}`, true);
                }
            }, 1000);
            
            setTimeout(() => {
                clearInterval(continuousInterval);
                continuousInterval = null;
                log('status-output', 'âœ… è¼ªè©¢å®Œæˆ');
            }, 10000);
        }

        async function syncTest() {
            clearLog('sync-output');
            updateStatus('sync-test', 'pending');
            
            try {
                log('sync-output', 'é–‹å§‹åŒæ­¥æ¸¬è©¦...');
                log('sync-output', 'æ­¥é©Ÿ 1: è§¸ç™¼è·Œå€’');
                
                await fetch(ESP32_URL + '/trigger-fall', { method: 'POST', mode: 'cors' });
                await new Promise(r => setTimeout(r, 1000));
                
                log('sync-output', 'æ­¥é©Ÿ 2: æª¢æŸ¥ ESP32 ç‹€æ…‹');
                let response = await fetch(ESP32_URL + '/status', { mode: 'cors' });
                let data = await response.json();
                log('sync-output', 'ESP32 å ±å‘Š: ' + data.status);
                
                if (data.status === 'fall') {
                    log('sync-output', 'âœ… ESP32 å·²æª¢æ¸¬åˆ°è·Œå€’');
                } else {
                    log('sync-output', 'âŒ ESP32 æœªæª¢æ¸¬åˆ°è·Œå€’', true);
                }
                
                log('sync-output', 'æ­¥é©Ÿ 3: æ¸…é™¤è·Œå€’');
                await fetch(ESP32_URL + '/clear-fall', { method: 'POST', mode: 'cors' });
                await new Promise(r => setTimeout(r, 1000));
                
                log('sync-output', 'æ­¥é©Ÿ 4: æª¢æŸ¥æœ€çµ‚ç‹€æ…‹');
                response = await fetch(ESP32_URL + '/status', { mode: 'cors' });
                data = await response.json();
                log('sync-output', 'ESP32 æœ€çµ‚ç‹€æ…‹: ' + data.status);
                
                if (data.status === 'safe') {
                    log('sync-output', 'âœ… åŒæ­¥æ¸¬è©¦é€šéï¼ç³»çµ±æ­£å¸¸å·¥ä½œ');
                    document.getElementById('sync-output').classList.add('success');
                    updateStatus('sync-test', 'ok');
                } else {
                    log('sync-output', 'âŒ åŒæ­¥å¤±æ•—', true);
                    updateStatus('sync-test', 'error');
                }
            } catch (error) {
                log('sync-output', 'âŒ æ¸¬è©¦å¤±æ•—: ' + error.message, true);
                updateStatus('sync-test', 'error');
            }
        }

        function updateStatus(elementId, status) {
            const elem = document.getElementById(elementId);
            elem.classList.remove('ok', 'error', 'pending');
            if (status === 'ok') {
                elem.classList.add('ok');
            } else if (status === 'error') {
                elem.classList.add('error');
            } else {
                elem.classList.add('pending');
            }
        }
    </script>
</body>
</html>
